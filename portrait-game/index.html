<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Tandemonium — Portrait</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  html, body {
    width: 100%; height: 100%; overflow: hidden;
    background: #000; touch-action: none;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    -webkit-user-select: none; user-select: none;
  }
  canvas { display: block; width: 100%; height: 100%; }

  /* ── HUD: top bar ── */
  #hud-top {
    position: fixed;
    top: env(safe-area-inset-top, 0px);
    left: 0; right: 0;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    padding: 10px 14px 0;
    pointer-events: none;
    z-index: 10;
  }
  #hud-top-left {
    color: #fff;
    font-size: 15px;
    font-weight: 600;
    text-shadow: 0 1px 4px rgba(0,0,0,0.6);
    line-height: 1.5;
  }
  #hud-top-right {
    display: flex;
    gap: 8px;
  }

  /* ── Gauges ── */
  .gauge-wrap {
    width: 60px; height: 60px;
    position: relative;
  }
  .gauge-wrap svg { width: 100%; height: 100%; }
  .gauge-label {
    position: absolute;
    bottom: -2px; left: 0; right: 0;
    text-align: center;
    font-size: 10px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 1px 3px rgba(0,0,0,0.7);
  }
  .gauge-title {
    position: absolute;
    top: -2px; left: 0; right: 0;
    text-align: center;
    font-size: 8px;
    font-weight: 600;
    color: rgba(255,255,255,0.7);
    text-shadow: 0 1px 2px rgba(0,0,0,0.5);
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .pedal-indicator {
    position: absolute;
    left: 0; right: 0;
    text-align: center;
    font-size: 14px;
    font-weight: 700;
    color: #a6f;
    opacity: 0;
    transition: opacity 0.08s;
    pointer-events: none;
    text-shadow: 0 0 6px rgba(170,102,255,0.6);
  }
  .pedal-indicator.flash { opacity: 1; }
  .pedal-indicator.pedal-up { top: -16px; }
  .pedal-indicator.pedal-down { bottom: -14px; }

  /* ── Status text (center) ── */
  #status {
    position: fixed;
    top: 38%;
    left: 0; right: 0;
    text-align: center;
    font-size: 22px;
    font-weight: 700;
    color: #fff;
    text-shadow: 0 2px 8px rgba(0,0,0,0.7);
    pointer-events: none;
    z-index: 10;
  }

  /* ── Left-side toggle buttons ── */
  #side-buttons {
    position: fixed;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    flex-direction: column;
    gap: 8px;
    z-index: 10;
  }
  .side-btn {
    padding: 8px 12px;
    border: 2px solid rgba(255,255,255,0.5);
    border-radius: 8px;
    background: rgba(0,0,0,0.4);
    color: #fff;
    font-size: 11px;
    font-weight: 700;
    cursor: pointer;
    pointer-events: auto;
    text-align: center;
    min-width: 70px;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
  }
  .side-btn.safety-on {
    background: rgba(40,180,60,0.6);
    border-color: rgba(40,180,60,0.8);
  }
  .side-btn.safety-off {
    background: rgba(200,40,40,0.6);
    border-color: rgba(200,40,40,0.8);
  }
  .side-btn.speed-on {
    background: rgba(40,100,220,0.6);
    border-color: rgba(40,100,220,0.8);
  }
  .side-btn.speed-off {
    background: rgba(80,80,80,0.5);
    border-color: rgba(150,150,150,0.4);
  }
  .side-btn.reset-btn {
    background: rgba(80,80,80,0.5);
    border-color: rgba(150,150,150,0.4);
  }

  /* ── Pedal touch buttons (bottom) ── */
  #pedal-bar {
    position: fixed;
    bottom: env(safe-area-inset-bottom, 0px);
    left: 0; right: 0;
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 8px 10px;
    pointer-events: none;
    z-index: 10;
  }
  .pedal-touch {
    width: 45%;
    height: 18vh;
    min-height: 80px;
    max-height: 140px;
    border-radius: 16px;
    border: 3px solid rgba(255,255,255,0.5);
    background: rgba(255,255,255,0.15);
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    display: flex;
    align-items: center;
    justify-content: center;
    pointer-events: auto;
    cursor: pointer;
    transition: background 0.08s, border-color 0.08s;
  }
  .pedal-touch img {
    max-width: 80%;
    max-height: 80%;
    object-fit: contain;
    pointer-events: none;
    opacity: 0.85;
  }
  .pedal-touch.pressed {
    background: rgba(60,200,80,0.4);
    border-color: rgba(60,200,80,0.8);
  }
  .pedal-touch.wrong {
    background: rgba(220,60,40,0.4);
    border-color: rgba(220,60,40,0.8);
  }
  .pedal-touch.brake {
    background: rgba(220,160,20,0.4);
    border-color: rgba(220,160,20,0.8);
  }

  /* ── Crash flash overlay ── */
  #crash-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,0,0,0);
    pointer-events: none;
    z-index: 9;
    transition: none;
  }

  /* ── Instructions overlay ── */
  #instructions {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 50;
    padding: 30px;
  }
  #instructions.hidden { display: none; }
  #instructions h1 {
    color: #fff;
    font-size: 28px;
    margin-bottom: 16px;
  }
  #instructions p {
    color: rgba(255,255,255,0.8);
    font-size: 15px;
    text-align: center;
    line-height: 1.6;
    max-width: 300px;
    margin-bottom: 10px;
  }
  #instructions .tap-hint {
    color: rgba(255,255,255,0.5);
    font-size: 13px;
    margin-top: 20px;
    animation: pulse 2s ease-in-out infinite;
  }
  @keyframes pulse {
    0%, 100% { opacity: 0.5; }
    50% { opacity: 1; }
  }

  /* ── Calibrate flash ── */
  #calibrate-flash {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(255,255,255,0.3);
    pointer-events: none;
    z-index: 8;
    display: none;
  }

  /* Desktop: hide pedal bar, show keyboard hint */
  @media (hover: hover) and (pointer: fine) {
    #pedal-bar { display: none; }
  }

  /* ── Lobby overlay ── */
  #lobby {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.85);
    z-index: 55;
    padding: 30px;
  }
  .lobby-card {
    text-align: center;
    max-width: 320px;
    width: 100%;
  }
  #lobby h1 {
    color: #fff;
    font-size: 28px;
    margin-bottom: 6px;
  }
  .lobby-subtitle {
    color: rgba(255,255,255,0.5);
    font-size: 13px;
    margin-bottom: 4px;
  }
  .lobby-version {
    color: rgba(255,255,255,0.3);
    font-size: 10px;
    margin-bottom: 20px;
    font-family: 'Courier New', monospace;
  }
  .lobby-step {
    display: flex;
    flex-direction: column;
    gap: 12px;
    align-items: center;
  }
  .lobby-btn {
    width: 100%;
    max-width: 280px;
    padding: 18px 20px;
    border-radius: 14px;
    border: 2px solid rgba(255,255,255,0.4);
    background: rgba(255,255,255,0.1);
    color: #fff;
    font-size: 16px;
    font-weight: 700;
    cursor: pointer;
    backdrop-filter: blur(4px);
    -webkit-backdrop-filter: blur(4px);
    text-align: center;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    line-height: 1.4;
    -webkit-tap-highlight-color: transparent;
  }
  .lobby-btn:active {
    background: rgba(255,255,255,0.2);
  }
  .lobby-btn-accent {
    background: rgba(60,200,80,0.25);
    border-color: rgba(60,200,80,0.6);
  }
  .lobby-btn-accent:active {
    background: rgba(60,200,80,0.4);
  }
  .lobby-role-desc {
    font-size: 12px;
    font-weight: 400;
    color: rgba(255,255,255,0.5);
  }
  .lobby-prompt {
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    margin-bottom: 4px;
  }
  .lobby-hint {
    color: rgba(255,255,255,0.4);
    font-size: 12px;
  }
  .lobby-back {
    background: none;
    border: none;
    color: rgba(255,255,255,0.4);
    font-size: 13px;
    cursor: pointer;
    padding: 8px;
    font-family: 'Helvetica Neue', Arial, sans-serif;
    -webkit-tap-highlight-color: transparent;
  }
  .lobby-back:active { color: rgba(255,255,255,0.7); }
  .room-code {
    font-size: 36px;
    font-weight: 700;
    color: #44ff66;
    letter-spacing: 4px;
    margin: 8px 0;
    text-shadow: 0 0 20px rgba(68,255,102,0.4);
  }
  .room-code-input {
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    letter-spacing: 3px;
    color: #fff;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.4);
    border-radius: 10px;
    padding: 12px;
    width: 100%;
    max-width: 240px;
    outline: none;
    text-transform: uppercase;
    font-family: 'Helvetica Neue', Arial, sans-serif;
  }
  .room-code-input:focus {
    border-color: #44ff66;
  }
  .room-code-prefix {
    font-size: 24px;
    font-weight: 700;
    color: rgba(255,255,255,0.5);
    letter-spacing: 3px;
    padding: 12px 0 12px 12px;
    background: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.4);
    border-right: none;
    border-radius: 10px 0 0 10px;
    font-family: 'Helvetica Neue', Arial, sans-serif;
  }
  .room-code-short {
    max-width: 130px;
    border-radius: 0 10px 10px 0;
  }
  .conn-status {
    font-size: 13px;
    color: rgba(255,255,255,0.5);
    min-height: 20px;
    animation: pulse 1.5s infinite;
  }
  .conn-status.connected { color: #44ff66; animation: none; }
  .conn-status.error { color: #ff4444; animation: none; }

  /* ── Disconnect overlay ── */
  #disconnect-overlay {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.85);
    z-index: 60;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 30px;
  }
  .disconnect-box {
    text-align: center;
  }
  .disconnect-box p {
    color: #ff6644;
    font-size: 20px;
    font-weight: 700;
    margin-bottom: 20px;
  }

  /* ── Connection badge ── */
  #conn-badge {
    position: fixed;
    top: env(safe-area-inset-top, 0px);
    left: 50%;
    transform: translateX(-50%);
    font-size: 10px;
    color: rgba(255,255,255,0.5);
    background: rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 10px;
    padding: 2px 8px;
    z-index: 11;
    pointer-events: none;
    margin-top: 4px;
  }
  #conn-badge #conn-type { color: #44ff66; font-weight: 700; margin-right: 4px; }
</style>
</head>
<body>

<!-- HUD -->
<div id="hud-top">
  <div id="hud-top-left">
    <div id="speed-display">Speed: 0 km/h</div>
    <div id="distance-display">Distance: 0 m</div>
  </div>
  <div id="hud-top-right">
    <div class="gauge-wrap" id="bike-gauge">
      <div class="gauge-title">BIKE</div>
      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="52" fill="rgba(0,0,0,0.5)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
        <!-- Red danger zones (left & right extremes) -->
        <path d="M 60 60 L 14.4 79.6 A 52 52 0 0 1 8 60 L 60 60" fill="rgba(255,50,50,0.25)"/>
        <path d="M 60 60 L 112 60 A 52 52 0 0 1 105.6 79.6 L 60 60" fill="rgba(255,50,50,0.25)"/>
        <!-- Top center mark -->
        <line x1="60" y1="9" x2="60" y2="18" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"/>
        <!-- Danger threshold marks -->
        <line x1="29" y1="20" x2="34" y2="28" stroke="rgba(255,50,50,0.5)" stroke-width="1"/>
        <line x1="91" y1="20" x2="86" y2="28" stroke="rgba(255,50,50,0.5)" stroke-width="1"/>
        <line x1="12" y1="44" x2="21" y2="47" stroke="rgba(255,50,50,0.5)" stroke-width="1"/>
        <line x1="108" y1="44" x2="99" y2="47" stroke="rgba(255,50,50,0.5)" stroke-width="1"/>
        <!-- Needle (horizontal bar style) -->
        <g id="bike-needle" transform="rotate(0, 60, 60)">
          <line x1="18" y1="60" x2="48" y2="60" stroke="#4af" stroke-width="3" stroke-linecap="round"/>
          <line x1="72" y1="60" x2="102" y2="60" stroke="#4af" stroke-width="3" stroke-linecap="round"/>
          <circle cx="60" cy="60" r="4" fill="none" stroke="#4af" stroke-width="2"/>
          <line x1="56" y1="60" x2="48" y2="60" stroke="#4af" stroke-width="2"/>
          <line x1="64" y1="60" x2="72" y2="60" stroke="#4af" stroke-width="2"/>
          <line x1="60" y1="56" x2="60" y2="50" stroke="#4af" stroke-width="2"/>
        </g>
        <!-- Top pointer -->
        <polygon points="60,10 57,16 63,16" fill="#fff" opacity="0.8"/>
      </svg>
      <div class="gauge-label" id="bike-label">0.0&deg;</div>
    </div>
    <div class="gauge-wrap" id="phone-gauge">
      <div class="gauge-title">YOU</div>
      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="52" fill="rgba(0,0,0,0.5)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
        <!-- Green safe zones (left & right of vertical) -->
        <path d="M 60 60 L 96.8 23.2 A 52 52 0 0 1 96.8 96.8 L 60 60" fill="rgba(0,180,0,0.2)"/>
        <path d="M 60 60 L 23.2 96.8 A 52 52 0 0 1 23.2 23.2 L 60 60" fill="rgba(0,180,0,0.2)"/>
        <!-- Top center mark -->
        <line x1="60" y1="9" x2="60" y2="18" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"/>
        <!-- Needle (horizontal bar style) -->
        <g id="phone-needle" transform="rotate(0, 60, 60)">
          <line x1="18" y1="60" x2="48" y2="60" stroke="#fa3" stroke-width="3" stroke-linecap="round"/>
          <line x1="72" y1="60" x2="102" y2="60" stroke="#fa3" stroke-width="3" stroke-linecap="round"/>
          <circle cx="60" cy="60" r="4" fill="none" stroke="#fa3" stroke-width="2"/>
          <line x1="56" y1="60" x2="48" y2="60" stroke="#fa3" stroke-width="2"/>
          <line x1="64" y1="60" x2="72" y2="60" stroke="#fa3" stroke-width="2"/>
          <line x1="60" y1="56" x2="60" y2="50" stroke="#fa3" stroke-width="2"/>
        </g>
        <!-- Top pointer -->
        <polygon points="60,10 57,16 63,16" fill="#fff" opacity="0.8"/>
      </svg>
      <div class="gauge-label" id="phone-label">0.0&deg;</div>
    </div>
    <div class="gauge-wrap" id="partner-gauge" style="display:none;">
      <div class="gauge-title">PARTNER</div>
      <div class="pedal-indicator pedal-up" id="partner-pedal-up">^</div>
      <svg viewBox="0 0 120 120">
        <circle cx="60" cy="60" r="52" fill="rgba(0,0,0,0.5)" stroke="rgba(255,255,255,0.3)" stroke-width="2"/>
        <path d="M 60 60 L 96.8 23.2 A 52 52 0 0 1 96.8 96.8 L 60 60" fill="rgba(170,102,255,0.15)"/>
        <path d="M 60 60 L 23.2 96.8 A 52 52 0 0 1 23.2 23.2 L 60 60" fill="rgba(170,102,255,0.15)"/>
        <line x1="60" y1="9" x2="60" y2="18" stroke="rgba(255,255,255,0.5)" stroke-width="1.5"/>
        <g id="partner-needle" transform="rotate(0, 60, 60)">
          <line x1="18" y1="60" x2="48" y2="60" stroke="#a6f" stroke-width="3" stroke-linecap="round"/>
          <line x1="72" y1="60" x2="102" y2="60" stroke="#a6f" stroke-width="3" stroke-linecap="round"/>
          <circle cx="60" cy="60" r="4" fill="none" stroke="#a6f" stroke-width="2"/>
          <line x1="56" y1="60" x2="48" y2="60" stroke="#a6f" stroke-width="2"/>
          <line x1="64" y1="60" x2="72" y2="60" stroke="#a6f" stroke-width="2"/>
          <line x1="60" y1="56" x2="60" y2="50" stroke="#a6f" stroke-width="2"/>
        </g>
        <polygon points="60,10 57,16 63,16" fill="#fff" opacity="0.8"/>
      </svg>
      <div class="gauge-label" id="partner-label">0.0&deg;</div>
      <div class="pedal-indicator pedal-down" id="partner-pedal-down">&#8964;</div>
    </div>
  </div>
</div>

<div id="status"></div>

<!-- Side buttons -->
<div id="side-buttons">
  <button class="side-btn safety-on" id="safety-btn">SAFETY ON</button>
  <button class="side-btn speed-off" id="speed-btn">SPEED OFF</button>
  <button class="side-btn reset-btn" id="reset-btn">RESET</button>
</div>

<!-- Pedal touch targets -->
<div id="pedal-bar">
  <div class="pedal-touch" id="touch-left"><img src="../images/left_pedal.png" alt="Left Pedal"></div>
  <div class="pedal-touch" id="touch-right"><img src="../images/right_pedal.png" alt="Right Pedal"></div>
</div>

<!-- Crash flash -->
<div id="crash-overlay"></div>

<!-- Calibrate flash -->
<div id="calibrate-flash"></div>

<!-- Instructions overlay (hidden initially — lobby shows first) -->
<div id="instructions" class="hidden">
  <h1>Tandemonium</h1>
  <p>Alternate LEFT/RIGHT pedals to ride.<br>Tilt your phone (or A/D keys) to steer and balance.</p>
  <p>Don't lean too far or you'll crash!</p>
  <p class="tap-hint">Tap anywhere to start</p>
</div>

<!-- Lobby overlay -->
<div id="lobby">
  <div class="lobby-card">
    <h1>Tandemonium</h1>
    <p class="lobby-subtitle">A Tandem Bicycle Physics Game</p>
    <p class="lobby-version" id="lobby-version">v.08978ae | 02-19-2026 17:25</p>

    <!-- Step 1: Mode selection -->
    <div id="lobby-mode" class="lobby-step">
      <button class="lobby-btn" id="btn-solo">SOLO RIDE</button>
      <button class="lobby-btn lobby-btn-accent" id="btn-together">RIDE TOGETHER</button>
    </div>

    <!-- Step 2: Role selection -->
    <div id="lobby-role" class="lobby-step" style="display:none;">
      <p class="lobby-prompt">Choose your seat:</p>
      <button class="lobby-btn" id="btn-captain">START A RIDE<br><span class="lobby-role-desc">Captain &middot; Front seat</span></button>
      <button class="lobby-btn" id="btn-stoker">JOIN A RIDE<br><span class="lobby-role-desc">Stoker &middot; Back seat</span></button>
      <button class="lobby-back" id="btn-back-mode">&larr; Back</button>
    </div>

    <!-- Step 3a: Captain waiting room -->
    <div id="lobby-host" class="lobby-step" style="display:none;">
      <p class="lobby-prompt">Your room code:</p>
      <div id="room-code-display" class="room-code">----</div>
      <p class="lobby-hint">Share this code with your partner</p>
      <div id="host-status" class="conn-status"></div>
      <button class="lobby-back" id="btn-back-role-host">&larr; Back</button>
    </div>

    <!-- Step 3b: Stoker join room -->
    <div id="lobby-join" class="lobby-step" style="display:none;">
      <p class="lobby-prompt">Enter room code:</p>
      <div style="display:flex;align-items:center;justify-content:center;gap:0;">
        <span class="room-code-prefix">TNDM-</span>
        <input type="text" id="room-code-input" class="room-code-input room-code-short" maxlength="4" placeholder="XXXX" autocomplete="off" autocapitalize="characters" spellcheck="false">
      </div>
      <button class="lobby-btn lobby-btn-accent" id="btn-join">JOIN</button>
      <div id="join-status" class="conn-status"></div>
      <button class="lobby-back" id="btn-back-role-join">&larr; Back</button>
    </div>
  </div>
</div>

<!-- Disconnect overlay -->
<div id="disconnect-overlay" style="display:none;">
  <div class="disconnect-box">
    <p id="disconnect-msg">Partner disconnected</p>
    <button class="lobby-btn" id="btn-return-lobby">Return to Lobby</button>
  </div>
</div>

<!-- Connection badge -->
<div id="conn-badge" style="display:none;">
  <span id="conn-type">P2P</span>
  <span id="conn-ping">--ms</span>
</div>

<!-- PeerJS (sets window.Peer) -->
<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>

<script type="importmap">
{
  "imports": {
    "three": "https://cdn.jsdelivr.net/npm/three@0.161.0/build/three.module.js",
    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.161.0/examples/jsm/"
  }
}
</script>

<script type="module" src="js/game.js"></script>

</body>
</html>
